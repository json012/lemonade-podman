# This file is intended to be chained with the other docker-compose files in this repo. 
# If it is not, you will need to redclare the networks and volumes in this file.

services:
  litellm-pgvector-db:
    build:
      context: ./pg-vector
    container_name: litellm-pgvector-db
    environment:
      POSTGRES_DB: ${RAG_DB_NAME}
      POSTGRES_USER: ${RAG_DB_USER}
      POSTGRES_PASSWORD: ${RAG_DB_PASS}
    volumes:
      - litellm-pgvector-data:/var/lib/postgresql/data
    networks:
      - litellm-pgvector-db-network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${RAG_DB_USER} -d ${RAG_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  litellm-pgvector:
    build:
      context: ./litellm-pgvector
    entrypoint: ["/bin/sh", "-c", "prisma db push --skip-generate && exec \"$@\"", "--"]
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "4001"]
    environment:
      - DATABASE_URL=postgres://${RAG_DB_USER}:${RAG_DB_PASS}@litellm-pgvector-db:5432/${RAG_DB_NAME}
      - SERVER_API_KEY=${RAG_SERVER_API_KEY}
      - HOST="0.0.0.0"
      - PORT=4001
      - EMBEDDING__MODEL="lemonade-nomic-embed-text-v2-moe-GGUF"
      - EMBEDDING__BASE_URL="http://litellm:4000"
      - EMBEDDING__API_KEY=${LITELLM_RAG_EMBEDDING_API_KEY}
      - EMBEDDING__DIMENSIONS=768
      - DB_FIELDS__ID_FIELD="id"
      - DB_FIELDS__CONTENT_FIELD="content"
      - DB_FIELDS__METADATA_FIELD="metadata"
      - DB_FIELDS__EMBEDDING_FIELD="embedding"
      - DB_FIELDS__VECTOR_STORE_ID_FIELD="vector_store_id"
      - DB_FIELDS__CREATED_AT_FIELD="created_at"
    volumes:
      - litellm-pgvector-data:/var/lib/postgresql/data
      - ./pg-vector/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    ports:
      - 4001:4001
    restart: unless-stopped
    depends_on:
      litellm-pgvector-db:
        condition: service_healthy
    healthcheck:
      test: [
        "CMD",
        "python3",
        "-c",
        "import urllib.request; urllib.request.urlopen('http://localhost:4001/health')"
      ]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3
    networks:
      - litellm-pgvector-db-network
      - litellm-network
      # Comment out the network and labels below this line if not making available online
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.litellm-pgvector.rule=Host(`${RAG_SERVER_HOST}`)"
      - "traefik.http.routers.litellm-pgvector.entrypoints=web"
      - "traefik.http.services.litellm-pgvector.loadbalancer.server.port=4001"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.sslhost=${RAG_SERVER_HOST}"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.sslredirect=true"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.stsseconds=315360000"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.browserxssfilter=true"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.contenttypenosniff=true"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.forcestsheader=true"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.stsincludesubdomains=true"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.stspreload=true"
      - "traefik.http.middlewares.litellm-pgvector-headers.headers.customframeoptionsvalue=SAMEORIGIN"
      - "traefik.http.routers.litellm-pgvector.middlewares=litellm-pgvector-headers"

volumes:
  litellm-pgvector-data:
    driver: local

networks:
  litellm-pgvector-db-network:
    driver: bridge
    internal: true
